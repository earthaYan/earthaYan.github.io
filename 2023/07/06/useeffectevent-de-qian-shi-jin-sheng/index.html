<!DOCTYPE html>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0,  viewport-fit=cover" name="viewport" />
    <meta name="description" content="useEffectEventçš„å‰ä¸–ä»Šç”Ÿ" />
    <meta name="hexo-theme-A4" content="v1.7.1" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>Diary</title>

    
        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
            
<link rel="stylesheet" href="/css/waline.css">

        
    
    
<link rel="stylesheet" href="/css/ui.css">
 
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>
    
    <body>
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    
<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">Diary</a> 
            <span class="description">å¤‡å¿˜å½•/ç¬”è®°æœ¬</span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">é¦–é¡µ</a></li>
            
        
            
                <li><a href="/list/">æ–‡ç« </a></li>
            
        
            
                <li><a href="/categories/">åˆ†ç±»</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            useEffectEventçš„å‰ä¸–ä»Šç”Ÿ
        </div>
      
    

    <div class="post-md">
        
            
        
        <p>å»å¹´ React å›¢é˜Ÿåˆ†äº«äº†ä¸€ä¸ªæ–° Hook <code>useEvent</code> çš„<a target="_blank" rel="noopener" href="https://github.com/reactjs/rfcs/pull/220">RFC220</a>,å®Œæ•´ RFC å†…å®¹è§<a target="_blank" rel="noopener" href="https://github.com/reactjs/rfcs/blob/useevent/text/0000-useevent.md">useEvent</a>ã€‚è¿™ä¸ª Hook çš„æ¥æºæ˜¯<a target="_blank" rel="noopener" href="https://github.com/facebook/react/issues/14099">#14099</a>ã€‚ useEvent çš„<a target="_blank" rel="noopener" href="https://github.com/facebook/react/pull/25229">åŸå‹</a>å·²ç»å®ç°ï¼Œä½†æ˜¯ä»Šå¹´ 1 æœˆä»½å…³é—­äº†<code>useEvent</code>ææ¡ˆï¼Œä¸ºä»€ä¹ˆä¼šå…³é—­å‘¢ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªåŸå› ï¼š</p>
<ol>
<li>å°†æ¸²æŸ“ä¼˜åŒ–å’Œâ€œä¿®å¤â€Effect è€¦åˆåœ¨ä¸€ä¸ªææ¡ˆä¸‹ï¼Œå¾ˆéš¾å®ç°</li>
<li>å®¹æ˜“è¯±å¯¼å¼€å‘è€…å°†å½“å‰ä½¿ç”¨ <code>useCallback</code> åŒ…è£¹çš„å‡½æ•°éƒ½æ›¿æ¢æˆ <code>useEvent</code></li>
</ol>
<p>ä½†æ˜¯å…³é—­ææ¡ˆå¹¶ä¸æ„å‘³ç€å…¨ç›˜å¦å®šï¼Œäº‹å®ä¸Šï¼Œåªæ˜¯å¯¹å…¶è¿›è¡Œäº†æ‹†åˆ†ã€‚é’ˆå¯¹æ¸²æŸ“ä¼˜åŒ–ï¼ŒReact å›¢é˜Ÿå‡†å¤‡å¼€å‘ä¸€ä¸ª<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=lGEMwh32soc">è‡ªåŠ¨è®°å¿†ç¼–è¯‘å™¨</a>ï¼Œè€Œé’ˆå¯¹ä¿®å¤ Effectï¼Œåˆ™å‘å¸ƒäº†ä¸€ä¸ª <code>useEffectEvent</code>çš„æ–°çš„ Hookã€‚</p>
<p>å®˜æ–¹ä¹‹å‰åœ¨ RFC ç»™å‡ºçš„ useEvent çš„å¤§æ¦‚å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼Œå½“ç„¶è¿™ä¸æ˜¯çœŸæ­£çš„å®ç°ï¼ŒçœŸæ­£çš„å®ç°è‚¯å®šæ¯”è¿™ä¸ªå¤æ‚å¾—å¤šï¼š</p>
<pre><code class="javascript">// (!) Approximate behavior
function useEvent(handler) &#123;
  const handlerRef = useRef(null);
  // æ¸²æŸ“ä¹‹å‰è¿è¡Œ
  useLayoutEffect(() =&gt; &#123;
    handlerRef.current = handler;
  &#125;);
  return useCallback((...args) =&gt; &#123;
    // æ¸²æŸ“æœŸé—´æ‰§è¡Œçš„è¯ï¼Œä¼šæŠ›å‡ºé”™è¯¯
    const fn = handlerRef.current;
    return fn(...args);
  &#125;, []);
&#125;
</code></pre>
<p>ä¸‹é¢å°±å€ŸåŠ©ä»£ç æ¥è®²è¿°ä¸€ä¸‹è¿™ä¸ªæ–°çš„ Hook åº”è¯¥æ€ä¹ˆä½¿ç”¨ã€‚<br>å½“å‰å­˜åœ¨çš„é—®é¢˜ï¼š<br>ä½ åˆ›å»ºäº†ä¸€ä¸ªèŠå¤©è¿æ¥ï¼ŒæŠŠå½“å‰çš„ message å­˜å‚¨åœ¨ state å˜é‡ä¸­ï¼Œæ¯æ¬¡è¾“å…¥çš„æ—¶å€™æ›´æ–° message,å½“ç”¨æˆ·å‡†å¤‡å¥½åå°±å¯ä»¥å‘é€ã€‚</p>
<pre><code class="javascript">function Chat() &#123;
  const [message, setMessage] = React.useState(&quot;&quot;);
  const sendMessage = (val) =&gt; &#123;
    console.log(val);
  &#125;;
  const onSend = () =&gt; &#123;
    sendMessage(message);
  &#125;;
  return (
    &lt;&gt;
      &lt;Input onSend=&#123;onSend&#125; setMessage=&#123;setMessage&#125; /&gt;
    &lt;/&gt;
  );
&#125;
</code></pre>
<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç”±äº <code>onSend</code> çš„å‡½æ•°å¼•ç”¨æ¯æ¬¡éƒ½ä¼šå˜åŒ–ï¼Œå³æ¯æ¬¡çš„ <code>onSend</code> éƒ½æ˜¯é‡æ–°åˆ›å»ºçš„ä¸åŒçš„å‡½æ•°ï¼Œè¿™ä¼šç›´æ¥ç ´å Input ç»„ä»¶çš„ memo æ•ˆæœï¼ŒåŸå› æ˜¯å½“ä¸€ä¸ªç»„ä»¶è¢« memoize å,ä¼šå¯¹ props è¿›è¡Œæµ…å±‚æ¯”è¾ƒæ¥å†³å®šæ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“ã€‚å¦‚æœ props æ˜¯â€œæµ…ç›¸ç­‰â€(åŒä¸€ä¸ªå¼•ç”¨),å°±è·³è¿‡é‡æ–°æ¸²æŸ“ã€‚è€Œ <code>onSend</code> æ¯æ¬¡éƒ½è·Ÿä¸Šä¸€æ¬¡ä¸ä¸€æ ·ã€‚</p>
<p>é‚£å¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿå¾ˆæ˜æ˜¾å¯ä»¥ä½¿ç”¨<code>useCallback</code>åŒ…è£¹<code>onSend</code>å‡½æ•°ï¼Œä¿è¯åªæœ‰ state å˜é‡å˜åŒ–æ—¶ï¼Œ<code>onSend</code>å‡½æ•°æ‰ä¼šè¢«é‡æ–°åˆ›å»ºã€‚</p>
<pre><code class="javascript">const onSend = React.useCallback(() =&gt; &#123;
  sendMessage(message);
&#125;, [message]);
</code></pre>
<p>é€šè¿‡è¿™ä¸ªä¿®æ”¹ï¼ŒInput ç»„ä»¶åªæœ‰åœ¨ <code>onSend</code> å‡½æ•°é‡æ–°åˆ›å»ºçš„æ—¶å€™ <code>Input</code> ç»„ä»¶æ‰ä¼šé‡æ–°æ¸²æŸ“ã€‚ä½†æ˜¯è¿™æ ·å¹¶ä¸å®Œå…¨å¥‘åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œå› ä¸ºæ¯å½“ message å˜åŒ–ï¼Œ <code>onSend</code> å‡½æ•°è¿˜æ˜¯ä¼šè¢«é‡æ–°åˆ›å»ºã€‚ä½†æ˜¯å¦‚æœå»æ‰ä¾èµ–é¡¹ï¼Œå°±è·å–ä¸åˆ°æœ€æ–°çš„ message å€¼ã€‚</p>
<img src="/2023/07/06/useeffectevent-de-qian-shi-jin-sheng/recreate.png" class="">

<p>è¿˜å¯ä»¥é€šè¿‡ ref ä¿®å¤è¿™ä¸ªé—®é¢˜:ä½¿ç”¨ sendRef å­˜å‚¨äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œè¿™æ ·ä½ è¾“å…¥çš„æ—¶å€™ onSend å‡½æ•°ä¼šä¸€ç›´ä¿æŒä¸ºåŒä¸€ä¸ªå‡½æ•°æ ‡è¯†ç¬¦</p>
<pre><code class="javascript">const sendRef = React.useRef(null);
React.useLayoutEffect(() =&gt; &#123;
  sendRef.current = () =&gt; sendMessage(message);
&#125;);
const onSend = React.useCallback((...args) =&gt; &#123;
  return sendRef.current(...args);
&#125;, []);
</code></pre>
<p>å°½ç®¡è¿™ä¸ªæ–¹æ³•èƒ½è§£å†³æˆ‘ä»¬çš„é—®é¢˜ï¼Œä½†æ˜¯å¾ˆæ˜æ˜¾ç‰ºç‰²äº†ä»£ç å¯è¯»æ€§ã€‚åŸºäºä»¥ä¸Šçš„é—®é¢˜ï¼ŒReact å›¢é˜Ÿæ¨å‡ºäº†ä¸€ä¸ªæ–°çš„ Hook <code>useEffectEvent</code>ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚</p>
<p>ä½†æ˜¯å› ä¸ºè¿™ä¸ª Hook ç›®å‰è¿˜æ²¡æœ‰åœ¨ç¨³å®šç‰ˆ React ä¸­å‘å¸ƒï¼Œæ‰€ä»¥éœ€è¦å…ˆå®‰è£…å®éªŒç‰ˆæœ¬çš„ React</p>
<pre><code class="bash">npm install react@experimental
npm install react-dom@experimental
npm install eslint-plugin-react-hooks@experimental
</code></pre>
<p>ç°åœ¨åªéœ€è¦ç›´æ¥ç”¨ <code>useEffectEvent</code> å°†å›è°ƒå‡½æ•°åŒ…è£¹èµ·æ¥å°±å¯ä»¥</p>
<pre><code class="javascript">import &#123; experimental_useEffectEvent as useEffectEvent &#125; from &quot;react&quot;;
const onSend = React.experimental_useEffectEvent(() =&gt; &#123;
  sendMessage(message);
&#125;);
</code></pre>
<p>æ–°çš„ Hook useEffectEvent å…è®¸ç”¨æˆ·å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥ä¸€ç›´è¯»å–åˆ°æœ€æ–°çš„ props&#x2F;stateï¼Œä½†æ˜¯å’Œè¿™ä¸ªå‡½æ•°ä¼šæœ‰ä¸€ä¸ªç¨³å®šçš„æ ‡è¯†ç¬¦ï¼Œæ‰€ä»¥ä»–ä¸ä¼šç ´åç¼“å­˜ï¼Œä¹Ÿä¸ä¼šé‡æ–°è§¦å‘ Effect,å¯ä»¥å‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“ã€‚å®ƒå’Œ <code>useCallback</code> çš„åŒºåˆ«æ˜¯:</p>
<ol>
<li>é‡æ¸²æŸ“æ¬¡æ•°çš„æ˜¾è‘—ä¸åŒï¼š<img src="/2023/07/06/useeffectevent-de-qian-shi-jin-sheng/retrigger.png" class=""></li>
<li>useEffectEvent ä¸éœ€è¦ä¾èµ–é¡¹åˆ—è¡¨</li>
</ol>
<p>useEvent çš„è¿”å›å€¼ï¼Œå®ƒçš„è¡Œä¸ºå°±å’Œæ™®é€šå‡½æ•°ä¸€æ ·ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç»™ä»–ä¼ é€’å‚æ•°ï¼Œæ¯”å¦‚ <code>roomID</code></p>
<pre><code class="javascript">const onSend = useEffectEvent((roomID) =&gt; &#123;
  sendMessage(roomID, message);
&#125;);
onSend(roomID);
</code></pre>
<p>å›åˆ° Chat ç»„ä»¶ï¼Œæ¯å½“ roomID å˜åŒ–æ—¶å°±å±•ç¤ºä¸€ä¸ªæˆåŠŸçš„ alert å¹¶æ¸…ç©º message,ä½¿ç”¨ useEffect å¯ä»¥è¾¾åˆ°ç›®çš„ã€‚</p>
<pre><code class="javascript">function Chat() &#123;
  const [message, setMessage] = React.useState(&quot;&quot;);
  const [roomID, setRoomID] = React.useState(&quot;reavel&quot;);
  const sendMessage = (val) =&gt; &#123;
    console.log(val);
  &#125;;
  const onSend = React.experimental_useEffectEvent(() =&gt; &#123;
    sendMessage(message);
  &#125;);
  React.useEffect(() =&gt; &#123;
    if (!!roomID) &#123;
      showNotification(&quot;Changed room-&gt;&quot; + roomID, &quot;dark&quot;);
      setMessage(&quot;&quot;);
    &#125;
  &#125;, [roomID]);
  return (
    &lt;&gt;
      &lt;div&gt;
        &lt;select
          onChange=&#123;(e) =&gt; &#123;
            setRoomID(e.target.value);
          &#125;&#125;
        &gt;
          &lt;option value=&quot;travel&quot;&gt;travel room&lt;/option&gt;
          &lt;option value=&quot;music&quot;&gt;music room&lt;/option&gt;
          &lt;option value=&quot;sport&quot;&gt;sport room&lt;/option&gt;
        &lt;/select&gt;
      &lt;/div&gt;
      &lt;Input onSend=&#123;onSend&#125; setMessage=&#123;setMessage&#125; message=&#123;message&#125; /&gt;
    &lt;/&gt;
  );
&#125;
</code></pre>
<p>ä½†æ˜¯å¦‚æœ toast æ˜¯ä»å½“å‰çš„ä¸»é¢˜ä¸Šä¸‹æ–‡ä¸­è¯»å–çš„è¯ï¼Œä»£ç æ£€æŸ¥å·¥å…·ä¼šæç¤ºä½ éœ€è¦å°† theme æ·»åŠ åˆ°ä¾èµ–é¡¹ä¸­</p>
<pre><code class="javascript">function Chat() &#123;
  const theme = useContext(ThemeContext);
  const [message, setMessage] = useState(&quot;&quot;);
  const onSend = useEffectEvent(() =&gt; &#123;
    setMessage(message);
  &#125;);

  React.useEffect(() =&gt; &#123;
    if (!!roomID) &#123;
      showNotification(&quot;Changed room-&gt;&quot; + roomID, theme);
      setMessage(&quot;&quot;);
    &#125;
  &#125;, [roomID, theme]);
  return &lt;Input onSend=&#123;onSend&#125; /&gt;;
&#125;
</code></pre>
<p>å®é™…ä¸Šä¸»é¢˜è‰²å˜åŒ–çš„æ—¶å€™ï¼Œè¿æ¥çš„æˆ¿é—´å¹¶æ²¡å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥å®é™…ä¸Šæˆ‘ä»¬å¹¶ä¸éœ€è¦é‡æ–°å±•ç¤ºæ¶ˆæ¯ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>useCallback</code> å°†ä»£ç ä» <code>useEffect</code> ä¸­æå–å‡ºæ¥ã€‚</p>
<pre><code class="javascript">const theme = useContext(ThemeContext);
const onChangedRoom = useCallback(() =&gt; &#123;
  showNotification(&quot;Changed room-&gt;&quot; + roomID, theme);
  setMessage(&quot;&quot;);
&#125;, [theme]);
useEffect(() =&gt; &#123;
  onChangedRoom();
&#125;, [roomID]);
return &lt;Input onSend=&#123;onSend&#125; /&gt;;
</code></pre>
<p>ä½†æ˜¯å› ä¸º <code>useEffectEvent</code> åœ¨é˜²æ­¢ä¸å¿…è¦çš„é‡æ¸²æŸ“ä¸Šæ›´æœ‰æ„ä¹‰,æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ <code>useEffectEvent</code> åŒ…è£¹å¯¹åº”çš„ä»£ç ï¼Œä½¿å®ƒå˜æˆéå“åº”å¼ä»£ç ã€‚</p>
<pre><code class="javascript">const theme = useContext(ThemeContext);
const onChangedRoom = useEffectEvent(() =&gt; &#123;
  showNotification(&quot;Changed room-&gt;&quot; + roomID, theme);
  setMessage(&quot;&quot;);
&#125;);
useEffect(() =&gt; &#123;
  onChangedRoom();
&#125;, [roomID]);
return &lt;Input onSend=&#123;onSend&#125; /&gt;;
</code></pre>
<p>è¿™æ ·æ—¢å‡å°‘äº†ä¸å¿…è¦çš„é‡æ¸²æŸ“ï¼Œä»£ç å¯è¯»æ€§ä¹Ÿå¾—åˆ°äº†æ”¹å–„ã€‚</p>
<p>é‚£å“ªäº›æƒ…å†µä¸é€‚åˆç”¨ useEffectEvent å‘¢ï¼Ÿå³éœ€è¦åœ¨æ¸²æŸ“æœŸé—´è°ƒç”¨çš„å‡½æ•°,å› ä¸º useEffectEvent åœ¨æ¸²æŸ“æœŸé—´è¿è¡Œä¼šæŠ›å‡ºé”™è¯¯</p>
<pre><code class="javascript">function ThemedGrid() &#123;
  const theme = useContext(ThemeContext);
  const renderItem = useCallback(
    (item) =&gt; &#123;
      // æ¸²æŸ“æœŸé—´è°ƒç”¨ï¼Œæ‰€ä»¥ä»–ä¸æ˜¯ä¸€ä¸ªäº‹ä»¶
      return &lt;Row &#123;...item&#125; theme=&#123;theme&#125; /&gt;;
    &#125;,
    [theme]
  );
  return &lt;Grid renderItem=&#123;renderItem&#125; /&gt;;
&#125;
</code></pre>
<p>ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://stackblitz.com/edit/stackblitz-starters-ida8fu">https://stackblitz.com/edit/stackblitz-starters-ida8fu</a></p>

    </div>

    <div class="post-meta">
        <i>
        
            <span>2023-07-06</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« Moon</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/tags/React/'>
                            React
                        </a>
                    
                </span>
             
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/categories/%E5%89%8D%E7%AB%AF/'>
                            å‰ç«¯
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    
        
    <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        ä»¥ä¸Šã€‚ 
    </div>
    
        

    <div id="waline"></div>
    <script type="module"  >
        import { init } from 'https://npm.elemecdn.com/hexo-theme-a4@latest/source/js/waline.mjs'; 
        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'https://comment-hexo-waline.vercel.app/',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
                search: false, // ç¦æ­¢è¡¨æƒ…åŒ…æœç´¢
                reaction: false, // å¯¹æ–‡ç« æ‰“åˆ†
                pageview: false, // æµè§ˆé‡ç»Ÿè®¡
                comment: false, // è¯„è®ºæ•°ç»Ÿè®¡

                locale: {
                    placeholder: 'æ­£ç¡®çš„é‚®ç®±åœ°å€ï¼Œå›å¤å°†èƒ½å¾—åˆ°é‚®ä»¶é€šçŸ¥ã€‚', 
                    sofa: ''
                },
            });
            
        }
        window.addEventListener('DOMContentLoaded', loadWaline);
    </script>



    
    
    
    </div>


     
</div>



                    
                    
                    <div class="footer">
    
        <span> 
            Â©2021-2023 China 

            
                

            
        </span>
    
</div>
<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>ğŸŒŠçœ‹è¿‡å¤§æµ·çš„äººä¸ä¼šå¿˜è®°æµ·çš„å¹¿é˜”ğŸŒŠ</span>
            
    
</div>


    
<link rel="stylesheet" href="/css/a11y-dark.min.css">

    
<script src="/js/highlight.min.js"></script>

    
<script src="/js/highlightjs-line-numbers.js"></script>



<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>
                </div>
            
    </body>
</html>