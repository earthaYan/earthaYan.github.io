---
title: äº‹ä»¶å¾ªçŽ¯æœºåˆ¶
date: 2023-07-13
tags: [JavaScript]
categories: å‰ç«¯
---

JavaScript åœ¨ chrome çš„è¿è¡ŒçŽ¯å¢ƒæ˜¯ Google çš„ V8 å¼•æ“Žï¼Œå®ƒçš„ç»“æž„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
{% asset_img js.png è¿è¡ŒçŽ¯å¢ƒç¤ºæ„å›¾ %}

ä»Žä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒV8 å¼•æ“Žä¸»è¦åŒ…å« 2 éƒ¨åˆ†ï¼š

- å†…å­˜å †ï¼šè¿›è¡Œå†…å­˜åˆ†é…
- è°ƒç”¨æ ˆï¼šå­˜å‚¨æ‰§è¡Œä¸Šä¸‹æ–‡
  åŒæ—¶ä¹Ÿå¯ä»¥å‘çŽ°æˆ‘ä»¬å¹³æ—¶ç”¨çš„ setTimeout æˆ–è€… DOMï¼Œå¹¶ä¸å­˜åœ¨äºŽ V8 å¼•æ“Žå†…éƒ¨ï¼Œè€Œæ˜¯æµè§ˆå™¨æä¾›çš„ï¼Œå®ƒä»¬ç»Ÿç§°ä¸º webAPIã€‚

## è°ƒç”¨æ ˆ

JS æ˜¯å•çº¿ç¨‹è¯­è¨€ï¼Œè¿™å°±æ„å‘³ç€å®ƒåªæœ‰ä¸€ä¸ªè°ƒç”¨æ ˆï¼Œå³åŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚å½“ç¨‹åºè¿›å…¥ä¸€ä¸ªå‡½æ•°æ—¶å€™ï¼Œå°†å…¶æ”¾åœ¨è°ƒç”¨æ ˆé¡¶å±‚ï¼Œå¦‚æžœæ‰§è¡Œå®Œè¿™ä¸ªå‡½æ•°ï¼Œå°±å°†å®ƒä»Žè°ƒç”¨æ ˆé¡¶å±‚å¼¹å‡ºã€‚

```javascript
function multiply(a, b) {
  return a * b;
}
function square(n) {
  return multiply(n, n);
}
function printSquare(n) {
  var squared = square(n);
  console.log(squared);
}
printSquare(4);
```

å¯¹åº”çš„è°ƒç”¨æ ˆï¼š
{% asset_img stack.png æ ˆè¿‡ç¨‹ç¤ºæ„å›¾%}
å †æ ˆæº¢å‡ºå°±æ˜¯å› ä¸ºè°ƒç”¨ä¸­çš„å‡½æ•°æ•°é‡è¶…å‡ºäº†è°ƒç”¨æ ˆçš„å®žé™…å¤§å°
{%asset_img error.png%}{%asset_img overflow.jpg æ ˆæº¢å‡º%}

## å•çº¿ç¨‹å¸¦æ¥çš„é—®é¢˜

ç”±äºŽ JS åªæœ‰ä¸€ä¸ªè°ƒç”¨æ ˆï¼Œå¦‚æžœæœ‰å‡½æ•°éœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´å¤„ç†ï¼Œæ¯”å¦‚ http è¯·æ±‚,è¯·æ±‚æœŸé—´ä¸èƒ½åšå…¶ä»–ä»»ä½•æ“ä½œï¼Œå¯¼è‡´é¡µé¢å¡ä½è¿è¡Œä¸æµç•…ã€‚å¯èƒ½æµè§ˆå™¨è¿˜ä¼šå¼¹å‡ºé”™è¯¯ï¼Œè¯¢é—®æ˜¯å¦åº”è¯¥ç»ˆæ­¢é¡µé¢ã€‚

## è§£å†³æ–¹æ³•ï¼šå¼‚æ­¥å›žè°ƒå‡½æ•°

äº§ç”Ÿäº†äº‹ä»¶å¾ªçŽ¯å’Œä»»åŠ¡é˜Ÿåˆ—çš„æ¦‚å¿µ
äº‹ä»¶å¾ªçŽ¯çš„æœ¬è´¨æ˜¯ï¼šç›‘è§†è°ƒç”¨æ ˆå’Œä»»åŠ¡é˜Ÿåˆ—ã€‚å¦‚æžœè°ƒç”¨æ ˆä¸ºç©ºï¼Œå®ƒå°†ä»Žé˜Ÿåˆ—ä¸­èŽ·å–ç¬¬ä¸€ä¸ªäº‹ä»¶ï¼Œå¹¶å°†å…¶æŽ¨é€åˆ°è°ƒç”¨å †æ ˆï¼Œç„¶åŽè¿è¡Œå®ƒã€‚

å¼‚æ­¥ä»»åŠ¡ä¸»è¦åŒ…æ‹¬å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ï¼š
å®ä»»åŠ¡ï¼šsetTimeout/setInterval,å›žè°ƒå‡½æ•°å°†åœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªçŽ¯ä¸­æ‰§è¡Œ
å¾®ä»»åŠ¡ï¼šPromise,process.nextTick,å›žè°ƒå‡½æ•°å°†ä¼šåœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªçŽ¯ä¹‹å‰æ‰§è¡Œ,ä½œä¸ºæœ¬æ¬¡äº‹ä»¶å¾ªçŽ¯çš„ task queue çš„é™„åŠ 

## æ‰§è¡Œé¡ºåº

1. ä¸»çº¿ç¨‹æ‰§è¡Œæ‰€æœ‰çš„åŒæ­¥ä»»åŠ¡ï¼Œç¢°åˆ°å¼‚æ­¥ä»»åŠ¡æ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­
2. è°ƒç”¨æ ˆæ¸…ç©ºåŽï¼ŒæŸ¥çœ‹å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—
3. æŸ¥çœ‹æœ¬æ¬¡äº‹ä»¶å¾ªçŽ¯ä¸­æ˜¯å¦æœ‰å¾®ä»»åŠ¡ï¼Œå¦‚æžœæœ‰ï¼Œå°±ç«‹åˆ»æ‰§è¡Œå¾®ä»»åŠ¡
4. å¾®ä»»åŠ¡æ‰§è¡Œå®ŒæˆåŽï¼Œå†åŽ»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–æ–°çš„å®ä»»åŠ¡æ”¾å…¥æ ˆä¸­

```javascript
console.log("1");
setTimeout(function () {
  console.log("2");
  process.nextTick(function () {
    console.log("3");
  });
  new Promise(function (resolve) {
    console.log("4");
    resolve();
  }).then(function () {
    console.log("5");
  });
});
process.nextTick(function () {
  console.log("6");
});
new Promise(function (resolve) {
  console.log("7");
  resolve();
}).then(function () {
  console.log("8");
});
setTimeout(function () {
  console.log("9");
  process.nextTick(function () {
    console.log("10");
  });
  new Promise(function (resolve) {
    console.log("11");
    resolve();
  }).then(function () {
    console.log("12");
  });
});
// 1,7,6,8,2,4,3,5,9,11,10,12
```

## å…³äºŽ asnyc...await çš„ä¸€äº›ç»†èŠ‚

async...await çš„å‡ºçŽ°æ˜¯ä¸ºäº†ç®€åŒ–ä½¿ç”¨å’Œç¼–å†™é“¾å¼ promise çš„è¿‡ç¨‹,ä½†æ˜¯ async å‡½æ•°ä¼šæ ¹æ®è¿”å›žå€¼çš„ç±»åž‹ï¼ŒV8 å¼•æ“Žçš„å¤„ç†æ–¹å¼ä¹Ÿä¸ä¸€æ ·ã€‚async å‡½æ•°åœ¨æŠ›å‡ºè¿”å›žå€¼æ—¶ï¼Œä¼šæ ¹æ®**è¿”å›žå€¼ç±»åž‹**å¼€å¯**ä¸åŒæ•°ç›®çš„å¾®ä»»åŠ¡**ã€‚
### asyncå‡½æ•°è¿”å›žå€¼ï¼š
1. è¿”å›žå€¼éž thenableï¼ˆéž promiseï¼‰ï¼šä¸ç­‰å¾…

```javascript
async function testA() {
  return 1;
}
testA().then(() => console.log(1));
Promise.resolve()
  .then(() => console.log(2))
  .then(() => console.log(3));
// (ä¸ç­‰å¾…)æœ€ç»ˆç»“æžœðŸ‘‰: 1 2 3
```

2. è¿”å›žå€¼ä¸º thenableï¼šç­‰å¾… 1 ä¸ª then çš„æ—¶é—´

```javascript
async function testB () {
 Â  Â return {
 Â  Â  Â  Â then (cb) {
 Â  Â  Â  Â  Â  Â cb();
 Â  Â  Â   }
 Â   };
}
testB().then(() => console.log(1));
Promise.resolve()
 Â   .then(() => console.log(2))
 Â   .then(() => console.log(3));
â€‹
// (ç­‰å¾…ä¸€ä¸ªthen)æœ€ç»ˆç»“æžœðŸ‘‰: 2 1 3
```

3. è¿”å›žå€¼ä¸º promise:ç­‰å¾… 2 ä¸ª then æ—¶é—´

```javascript
async function testC() {
  return new Promise((resolve, reject) => {
    resolve();
  });
}

testC().then(() => console.log(1));
Promise.resolve()
  .then(() => console.log(2))
  .then(() => console.log(3))
  .then(() => console.log(4));

// (ç­‰å¾…ä¸¤ä¸ªthen)æœ€ç»ˆç»“æžœðŸ‘‰: 2 3 1 4
```
### await å³å€¼ç±»åž‹çš„åŒºåˆ«
1. æŽ¥éžthenableç±»åž‹ï¼šä¼šç«‹å³å‘å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªå¾®ä»»åŠ¡then,ä½†æ˜¯ä¸éœ€è¦ç­‰å¾…
```javascript
async function test () {
 Â  Â console.log(1);
 Â  Â await 1;
 Â  Â console.log(2);
}
test();
console.log(3);
// æœ€ç»ˆç»“æžœðŸ‘‰: 1 3 2

```
2. æŽ¥thenableç±»åž‹ï¼šéœ€è¦ç­‰å¾…ä¸€ä¸ª then çš„æ—¶é—´ä¹‹åŽæ‰§è¡Œ
```javascript
async function test () {
 Â  Â console.log(1);
 Â  Â await {
 Â  Â  Â  Â then (cb) {
 Â  Â  Â  Â  Â  Â cb();
 Â  Â  Â   },
 Â   };
 Â  Â console.log(2);
}
â€‹
test();
console.log(3);
â€‹
Promise.resolve()
 Â   .then(() => console.log(4))
 Â   .then(() => console.log(5))
 Â   .then(() => console.log(6))
 Â   .then(() => console.log(7));
â€‹
// æœ€ç»ˆç»“æžœðŸ‘‰: 1 3 4 2 5 6 7

```
3. æŽ¥promiseç±»åž‹ï¼ˆæœ‰ç¡®å®šçš„è¿”å›žå€¼ï¼‰ï¼šç«‹å³å‘å¾®ä»»åŠ¡é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå¾®ä»»åŠ¡thenï¼Œä½†ä¸éœ€ç­‰å¾…
```javascript
async function test () {
 Â  Â console.log(1);
 Â  Â await new Promise((resolve, reject) => {
 Â  Â  Â  Â resolve()
 Â   })
 Â  Â console.log(2);
}
â€‹
test();
console.log(3);
â€‹
Promise.resolve()
 Â   .then(() => console.log(4))
 Â   .then(() => console.log(5))
 Â   .then(() => console.log(6))
 Â   .then(() => console.log(7));
â€‹
// æœ€ç»ˆç»“æžœðŸ‘‰: 1 3 2 4 5 6 7
```

